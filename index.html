<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RSNGMN Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Roboto',sans-serif;background:#000;color:#fff;margin:0;display:flex;flex-direction:column;height:100vh; }
    header { padding:12px 16px;border-bottom:1px solid #444;font-weight:700;text-transform:uppercase;letter-spacing:2px; }
    main { flex:1;display:flex;flex-direction:column; }
    #messages { flex:1;overflow-y:auto;padding:16px; }
    .msg { margin-bottom:10px;max-width:70%;padding:8px 12px;border-radius:6px;line-height:1.4;font-size:14px;background:#111; }
    .mine { background:#fff;color:#000;margin-left:auto; }
    .meta { font-size:11px;opacity:0.6;margin-bottom:2px; }
    .controls { border-top:1px solid #444;display:flex;gap:8px;padding:10px;background:#000; }
    input,button { font-family:'Roboto',sans-serif;font-size:14px;padding:8px;border:none;outline:none; }
    input { flex:1;background:#111;color:#fff; }
    button { background:#fff;color:#000;cursor:pointer;font-weight:500; }
    button:hover{ background:#ccc; }
    #status { font-size:12px;opacity:0.7;padding:4px 10px;border-top:1px solid #444; }
    #adminTools { border-top:1px solid #444;padding:8px 10px;font-size:12px;display:none; }
    #adminTools button { background:#111;color:#fff;border:1px solid #444;padding:6px 8px;font-size:12px; }
    #joinBox { border-top:1px solid #444;padding:8px 10px;display:none; }
    #joinBox input { background:#111;color:#fff;width:70%;margin-right:8px; }
    #joinBox button { background:#111;color:#fff;border:1px solid #444;font-size:12px; }
  </style>
</head>
<body>
  <header>RSNGMN Chat</header>

  <main>
    <div id="messages"></div>
    <div class="controls">
      <input id="textInput" placeholder="Message..." />
      <button id="sendBtn">Send</button>
    </div>
    <div id="adminTools">
      <button id="exportKeyBtn">Export Room Key</button>
      <button id="revokeBtn">Revoke Key</button>
    </div>
    <div id="joinBox">
      <input id="pasteKey" placeholder="Paste key here" />
      <button id="joinBtn">Join</button>
    </div>
    <div id="status">Connecting…</div>
  </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore.js";

// Your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCquKmonZI6sXLCIzl8BVz_QayGZK6yY9A",
  authDomain: "rsngmn-6da62.firebaseapp.com",
  projectId: "rsngmn-6da62",
  storageBucket: "rsngmn-6da62.appspot.com", // FIXED STORAGE BUCKET
  messagingSenderId: "1045190357466",
  appId: "1:1045190357466:web:100a639d820269fce6d0e3"
};

// Init
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Cookie utils */
function setCookie(name,value,days=365){
  const ex=new Date(Date.now()+days*864e5).toUTCString();
  document.cookie=`${name}=${encodeURIComponent(value)};expires=${ex};path=/;SameSite=Lax`;
}
function getCookie(name){
  const v=document.cookie.split('; ').find(r=>r.startsWith(name+'='));
  return v?decodeURIComponent(v.split('=')[1]):null;
}

/* Crypto helpers */
const enc=new TextEncoder(),dec=new TextDecoder();
async function genKey(){return crypto.subtle.generateKey({name:"AES-GCM",length:256},true,["encrypt","decrypt"]);}
async function expKey(k){
  const raw=await crypto.subtle.exportKey("raw",k);
  return btoa(String.fromCharCode(...new Uint8Array(raw)));
}
async function impKey(b64){
  const bin=atob(b64),buf=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++)buf[i]=bin.charCodeAt(i);
  return crypto.subtle.importKey("raw",buf.buffer,"AES-GCM",true,["encrypt","decrypt"]);
}
function randIv(){return crypto.getRandomValues(new Uint8Array(12));}
async function encryptText(txt,key){
  const iv=randIv();
  const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,enc.encode(txt));
  return {
    cipher: btoa(String.fromCharCode(...new Uint8Array(ct))),
    iv: btoa(String.fromCharCode(...iv))
  };
}
async function decryptText(ciph,ivB64,key){
  try{
    const ct=Uint8Array.from(atob(ciph),c=>c.charCodeAt(0)).buffer;
    const iv=Uint8Array.from(atob(ivB64),c=>c.charCodeAt(0));
    const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv},key,ct);
    return dec.decode(pt);
  }catch(e){
    return null;
  }
}

/* UI */
const sendBtn=document.getElementById('sendBtn');
const textInput=document.getElementById('textInput');
const messagesDiv=document.getElementById('messages');
const status=document.getElementById('status');
const adminTools=document.getElementById('adminTools');
const exportKeyBtn=document.getElementById('exportKeyBtn');
const revokeBtn=document.getElementById('revokeBtn');
const joinBox=document.getElementById('joinBox');
const pasteKey=document.getElementById('pasteKey');
const joinBtn=document.getElementById('joinBtn');

let myUid=null;
let key=null;
let isAdmin=false;

/* Auth */
onAuthStateChanged(auth,user=>{
  if(user){
    myUid=user.uid; 
    status.innerText = "Authenticated. Loading room…";
    init();
  }
  else signInAnonymously(auth);
});

async function init(){
  let b64=getCookie("rsngmn_key");
  const metaDoc = doc(db,"meta","room");
  const snap = await getDoc(metaDoc);

  if(!b64){
    if(!snap.exists()){
      // First visitor becomes admin
      key=await genKey();
      b64=await expKey(key);
      setCookie("rsngmn_key",b64);
      await setDoc(metaDoc,{admin:myUid,createdAt:Date.now()});
      isAdmin=true;
      status.innerText = "You are admin. Room created.";
    }else{
      // Show join box
      joinBox.style.display="block";
      status.innerText = "Room exists. Paste key to join.";
      return;
    }
  }else{
    key=await impKey(b64);
    if(snap.exists() && snap.data().admin===myUid){
      isAdmin=true;
      status.innerText = "You are admin.";
    }else{
      status.innerText = "Joined as guest.";
    }
  }

  if(isAdmin){ adminTools.style.display="block"; }
  listen();
}

/* Join flow */
joinBtn.onclick=async()=>{
  const pasted=pasteKey.value.trim();
  if(!pasted)return alert("Paste a key first");
  try{
    await impKey(pasted); // just test it
    setCookie("rsngmn_key",pasted);
    location.reload();
  }catch(e){
    alert("Invalid key format");
  }
};

/* Send */
sendBtn.onclick=async()=>{
  const txt=textInput.value.trim();if(!txt||!key)return;
  try {
    const {cipher,iv}=await encryptText(txt,key);
    await addDoc(collection(db,"rooms","rsngmn","messages"),{
      senderId:myUid,cipher,iv,
      createdAt:serverTimestamp()
    });
    textInput.value="";
    status.innerText = "Message sent.";
  } catch (e) {
    status.innerText = "Failed to send message.";
  }
};

// Allow Enter key to send
textInput.addEventListener('keypress',e=>{
  if(e.key==="Enter") sendBtn.onclick();
});

/* Listen */
function listen(){
  const q=query(collection(db,"rooms","rsngmn","messages"),orderBy("createdAt","asc"));
  onSnapshot(q,async snap=>{
    messagesDiv.innerHTML="";
    for(const docSnap of snap.docs){
      const d=docSnap.data();
      let msg="<i>locked</i>";
      if(key){
        const plain=await decryptText(d.cipher,d.iv,key);
        if(plain!==null)msg=escapeHtml(plain);
      }
      const wrap=document.createElement("div");
      wrap.className="msg"+(d.senderId===myUid?" mine":"");
      wrap.innerHTML=`<div class="meta">${d.senderId.slice(0,6)}</div><div>${msg}</div>`;
      messagesDiv.appendChild(wrap);
    }
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  });
}

/* Admin */
exportKeyBtn.onclick=()=>{
  const b64=getCookie("rsngmn_key");
  if(!b64)return alert("No key cookie.");
  prompt("Copy room key:",b64);
};
revokeBtn.onclick=()=>{
  document.cookie="rsngmn_key=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;";
  location.reload();
};

function escapeHtml(t){return t.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));}
</script>
</body>
</html>
